// requires: jquery
function crm(){}crm.prototype={investigator_id:0,investigator_role:null,investigator_role_id:null,note_dialog:Object,update_dialog:Object,update_redactor:Object,method:null,id:null,other_param:null,compeletion_reason:null,from_follow_up:!1,follow_up_company_id:0,search_running:!1,$user_profile_dialog:null,$user_profile_dialog_content:null,selected_user_profile:0,TAB_USER_DIALOG_PROFILE:0,TAB_USER_DIALOG_COMMENTS:-1,TAB_USER_DIALOG_COMPLAINTS:-1,TAB_USER_DIALOG_STRIPE:-1,TAB_USER_DIALOG_HISTORY:-1,TAB_USER_DIALOG_TRANSACTIONS:-1,binds:function(){var e=this;$("input.search_leads").die();$("input.search_leads").keyup(function(t){t.preventDefault();e.search($(this).val())});$("#search").find("form").submit(function(e){e.preventDefault();$sb.crm.manual_search()});$('[id^="lead_actions"]').unbind("click");$('[id^="lead_actions"]').bind("click",function(){switch($(this).attr("id")){case"lead_actions_mark_as_half_complete_level1":e.lead_actions_mark_as_half_complete_level1($(this).attr("data-company_id"));break;case"lead_actions_mark_as_complete_level1":e.lead_actions_mark_as_complete_level1($(this).attr("data-company_id"));break;case"lead_actions_mark_as_dead_level_1b":e.lead_actions_mark_as_dead_level_1b($(this).attr("data-company_id"));break;case"lead_actions_mark_as_complete_level2":e.lead_actions_mark_as_complete_level2($(this).attr("data-company_id"),!1);break;case"lead_actions_mark_as_complete_level3":e.lead_actions_mark_as_complete_level3($(this).attr("data-company_id"),!1);break;case"lead_actions_mark_as_needs_follow_up":e.lead_actions_mark_as_needs_follow_up($(this).attr("data-company_id"),!1);break;case"lead_actions_mark_ready_for_mailing":e.lead_actions_mark_ready_for_mailing($(this).attr("data-company_id"));break;case"lead_actions_send_back":e.lead_actions_send_back($(this).attr("data-company_id"));break;case"lead_actions_dead":e.lead_actions_dead($(this).attr("data-company_id"));break;case"lead_actions_add_note":e.create_note($(this).attr("data-company_id"));break;case"lead_actions_add_update":e.create_update($(this).attr("data-company_id"));break;case"lead_actions_add_follow_up":e.create_update($(this).attr("data-company_id"));e.from_follow_up=!0;e.follow_up_company_id=$(this).attr("data-company_id");break;case"lead_actions_request_more_information":e.lead_actions_request_more_information($(this).attr("data-company_id"))}});$("#select_compeletion_reason").unbind("change");$("#select_compeletion_reason").bind("change",function(){e.compeletion_reason=$(this).val();$(this).val()!=""?$("#alertActions").find("button.btn-primary").show():$("#alertActions").find("button.btn-primary").hide()});$("#user_submitted_info").click(function(){var t=$(this).attr("data-company_id"),n=$(this).attr("data-reassign_lead")==="true"?!0:!1;e.user_submitted_info(t,n,!1)});e.$user_profile_dialog_content=$("#user_profile_dialog_content");e.$user_profile_dialog=$("#user_profile_dialog").dialog({autoOpen:!1,width:900,height:580,open:function(){e.load_profile_dialog_user()},close:function(){e.$user_profile_dialog.dialog("option","title","")}});$(".user-profile").live("click",function(){e.selected_user_profile=$(this).attr("data-user_id");e.$user_profile_dialog.dialog("isOpen")?e.load_profile_dialog_user():e.$user_profile_dialog.dialog("open")});$(".refund").live("click",function(){var t=$(this);t.html("Refunding...");$.post("/ajax_stripe_refund",{user_account_id:$(this).attr("data-user_account_id"),charge_id:$(this).attr("data-stripe_id")},function(t){e.load_user_profile_stripe_tab(e.selected_user_profile)})})},load_profile_dialog_user:function(){var e=this;e.$user_profile_dialog_content.html('<span id="dialog_loader" style="float:left;width:100%;height:490px;text-align:center;background:url(\'/media/images/crm/loaders/indicator-big.gif\') no-repeat center 50%"></span>');e.$user_profile_dialog.dialog("option","title","Loading...");$.getJSON("/get_user_profile",{user_id:e.selected_user_profile},function(t){if(t.data.error===""&&t.data.user){e.$user_profile_dialog.dialog("option","title",t.data.user.name);e.$user_profile_dialog_content.html(t.html);$("#user_profile_dialog_tabs").tabs({selected:0}).bind("tabsshow",function(t,n){if(n.index===e.TAB_USER_DIALOG_TRANSACTIONS){$("#transactions_tab").html("<div style=\"width:100%;height:445px;text-align:center;background:url('/media/images/crm/loaders/indicator-big.gif') no-repeat center 50%\"></div>");$.getJSON("/get_user_profile_transactions",{user_id:e.selected_user_profile},function(e){$("#transactions_tab").html(e.data.html)})}else n.index===e.TAB_USER_DIALOG_STRIPE&&e.load_user_profile_stripe_tab(e.selected_user_profile)});$("#history_tabs").tabs();e.TAB_USER_DIALOG_COMPLAINTS=$('#user_profile_dialog_tabs a[href="#complaints_tab"]').parent().index();e.TAB_USER_DIALOG_COMMENTS=$('#user_profile_dialog_tabs a[href="#comments_tab"]').parent().index();e.TAB_USER_DIALOG_STRIPE=$('#user_profile_dialog_tabs a[href="#stripe_tab"]').parent().index();e.TAB_USER_DIALOG_HISTORY=$('#user_profile_dialog_tabs a[href="#history_tab"]').parent().index();e.TAB_USER_DIALOG_TRANSACTIONS=$('#user_profile_dialog_tabs a[href="#transactions_tab"]').parent().index();if(e.TAB_USER_DIALOG_COMPLAINTS!==-1){$("#user_profile_dialog_tabs ul li a").eq(e.TAB_USER_DIALOG_COMPLAINTS).text("Complaints"+(t.data.num_complaints>0?" ("+t.data.num_complaints+")":""));t.data.num_complaints===0&&$("#user_profile_dialog_tabs").tabs("disable",e.TAB_USER_DIALOG_COMPLAINTS)}t.data.num_comments===0&&$("#user_profile_dialog_tabs").tabs("disable",e.TAB_USER_DIALOG_COMMENTS);if(e.TAB_USER_DIALOG_HISTORY!==-1){t.data.num_regular_user_history>0&&$("#user_profile_dialog_tabs ul li a").eq(e.TAB_USER_DIALOG_HISTORY).text("History"+(t.data.num_regular_user_history>0?" ("+t.data.num_regular_user_history+")":""));t.data.num_history===0&&t.data.num_regular_user_history===0&&$("#user_profile_dialog_tabs").tabs("disable",e.TAB_USER_DIALOG_HISTORY)}$("#goto_user_compalaints_tab").click(function(){$("#user_profile_dialog_tabs").tabs("select",e.TAB_USER_DIALOG_COMPLAINTS)})}else e.$user_profile_dialog_content.html('<p class="error">'+t.data.error+"</p>")})},add_follow_up:function(e){var t=$sb.ajax;t.get("/lead_actions_add_follow_up/"+e,"",function(e){})},create_note:function(e){this.note_dialog.dialog("open")},create_update:function(e){this.update_redactor=$("textarea#update_textarea").redactor({autoresize:!1,buttons:["formatting","|","bold","italic","list","|","unorderedlist","orderedlist","outdent","indent","|","table","link"]});this.update_dialog.dialog("open")},notifications:function(){},manual_search:function(){this.search($("input.search_leads").val())},search:function(e){if($sb.empty(e))return!1;if($sb.crm.search_running)return!1;var t=$sb.ajax;t.before=function(){$sb.crm.search_running=!0};t.post("/search",{query:e},function(e){typeof e.html!="undefined"&&$sb.crm._write_search_results(e.html);$sb.crm.search_running=!1})},lead_actions_dead:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark as Complete",text:"<p>Are you sure you want to mark this lead as dead? This action cannot be undone.</p>",callback:function(){n.lead_actions_dead(e,!0)}});return}var r=$sb.ajax;r.get("/lead_actions_mark_as_dead/"+e)},lead_actions_mark_as_half_complete_level1:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark as Complete",text:"<p>Are you sure you want to send this to Investigator 1B? This action cannot be undone.</p>",callback:function(){n.lead_actions_mark_as_half_complete_level1(e,!0)}});return}var r=$sb.ajax;r.get("/lead_actions_mark_as_complete/"+e)},lead_actions_mark_as_complete_level1:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark as Complete",text:"<p>Are you sure you want to mark this lead as complete?  This action cannot be undone.</p>",callback:function(){n.lead_actions_mark_as_complete_level1(e,!0)}});return}var r=$sb.ajax;r.get("/lead_actions_mark_as_complete/"+e)},lead_actions_mark_as_dead_level_1b:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark as Dead",text:'<p>Are you sure you want to mark this lead as dead?  This action cannot be undone. Please select closure reason:</p><select id="select_compeletion_reason"><option value="">Select Reason for Closure</option><option value="no_business">Out of or no longer in business</option><option value="western_union">Western union scams</option><option value="craigslist">Craigslist</option><option value="dating_scam">Dating profile scams(not dating sites)</option><option value="ebay">Ebay user scams</option><option value="one_anon_complaint">Only 1 anonymous complaint leads</option><option value="duplicate_lead_consolidate">Duplicate leads that require consolidation</option><option value="duplicate_lead_co_signed_up">Duplicate leads for companies that have already signed up</option><option value="international">International scams(non us/uk/canada/australia)</option></select>',callback:function(){n.lead_actions_mark_as_dead_level_1b(e,!0)}});$("#alertActions").find("button.btn-primary").hide();n.binds();return}var r=$sb.ajax,i=n.compeletion_reason;r.get("/lead_actions_mark_as_dead/"+e+"/"+i)},lead_actions_mark_as_complete_level2:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark as Complete",text:'<p>Are you sure you want to mark this lead as complete?  This action cannot be undone.</p><select id="select_compeletion_reason"><option value="">Select Reason for Closure</option><option value="signed_up">Signed Up</option><option value="interested">Interested</option><option value="not_interested">Not Interested</option></select>',callback:function(){n.lead_actions_mark_as_complete_level2(e,!0)}});$("#alertActions").find("button.btn-primary").hide();n.binds();return}var r=$sb.ajax,i=n.compeletion_reason;r.get("/lead_actions_mark_as_complete/"+e+"/"+i)},lead_actions_mark_as_complete_level3:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark as Complete",text:'<p>Are you sure you want to mark this lead as complete?  This action cannot be undone.</p><select id="select_compeletion_reason"><option value="">Select Reason for Closure</option><option value="signed_up">Signed Up</option><option value="not_interested">Not Interested</option></select>',callback:function(){n.lead_actions_mark_as_complete_level3(e,!0)}});$("#alertActions").find("button.btn-primary").hide();n.binds();return}var r=$sb.ajax,i=n.compeletion_reason;r.get("/lead_actions_mark_as_complete/"+e+"/"+i)},lead_actions_mark_as_needs_follow_up:function(e,t){var n=this;if(!t)$.alert({type:"confirm",title:"Mark as Needs Follow Up",text:'<p>Are you sure you want to mark this lead as "needs follow up"?  This action cannot be undone.',callback:function(){n.lead_actions_mark_as_needs_follow_up(e,!0)}});else{var r=$sb.ajax;r.get("/lead_actions_mark_as_needs_follow_up/"+e)}},lead_actions_mark_ready_for_mailing:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Mark Ready for Mailing",text:"<p>Are you sure you want to mark this lead as ready for mailing?  This action cannot be undone.</p>",callback:function(){n.lead_actions_mark_ready_for_mailing(e,!0)}});return}var r=$sb.ajax;r.get("/lead_actions_mark_ready_for_mailing/"+e)},lead_actions_request_more_information:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Request More Information",text:"<p>Are you sure you want to request more information from every user that created a report for this lead?  This action cannot be undone.</p>",callback:function(){n.lead_actions_request_more_information(e,!0)}});return}var r=$sb.ajax;r.get("/lead_actions_request_more_information/"+e)},lead_actions_send_back:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Send Back to Level 1 Investigator",text:"<p>Are you sure you want to send this back to a Level 1 Investigator?  This action cannot be undone.</p>",callback:function(){n.lead_actions_send_back(e,!0)}});return}var r=$sb.ajax;r.get("/lead_actions_send_back/"+e)},_init:function(){this._set_investigator();this.notifications();this.binds();this._setup_dialogs();this.method=$sb.controller;this.id=$sb.method;this.other_param=$sb.id},_get_notifications:function(){},_set_investigator:function(){$sb.empty($("#crm_investigator_id").val())||(this.investigator_id=$("#crm_investigator_id").val())},_save_note:function(){var e=$sb.ajax,t=$sb.method,n=$("#note_textarea").val();e.post("/save_note/"+t,{note_body:n})},_save_update:function(){var e=this,t=$sb.ajax,n=$sb.method,r=this.update_redactor.getCode();if(e.from_follow_up)var i="/save_update/"+n+"/"+e.from_follow_up;else var i="/save_update/"+n;t.post(i,{note_body:r},function(t){e.from_follow_up&&e.add_follow_up(e.follow_up_company_id)})},_setup_dialogs:function(){var e=this;this.note_dialog=$("#note_dialog");this.update_dialog=$("#update_dialog");$sb.is_dialog(this.note_dialog)||this.note_dialog.dialog({autoOpen:!1,width:650,height:450,buttons:{Cancel:function(){$(this).dialog("close")},Save:function(){e._save_note()}}});$sb.is_dialog(this.update_dialog)||this.update_dialog.dialog({autoOpen:!1,width:650,height:450,buttons:{Cancel:function(){$(this).dialog("close")},Save:function(){e._save_update()}}})},_write_search_results:function(e){if($sb.empty(e))return!1;if($(".container")){$("#search_results").remove();$(".container").find(".container-leads")&&$(".container").find(".container-leads").remove();$(".container").prepend(e)}},user_submitted_info:function(e,t,n){var r=this;if(!n){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Are you sure? This action will:"+(t?"<br>- Reassign lead to Investigator 2/3":"")+"<br>- Put lead in top of Priority Call List</p>",callback:function(){r.user_submitted_info(e,t,!0)}});return}$.ajax({url:"/ajax_user_submitted_info",type:"POST",data:{company_id:e},dataType:"json",success:function(t){document.location="/manage_company/"+e}})},load_user_profile_stripe_tab:function(e){$("#stripe_tab").html("<div style=\"width:100%;height:445px;text-align:center;background:url('/media/images/crm/loaders/indicator-big.gif') no-repeat center 50%\"></div>");$.getJSON("/get_user_profile_stripe",{user_id:e},function(e){$("#stripe_tab").html(e.data.html)})}};$sb.crm=new crm;$(document).ready(function(){$sb.crm._init()});