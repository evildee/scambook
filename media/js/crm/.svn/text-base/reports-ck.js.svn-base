function Reports(){}Reports.prototype={table_ajax_request:null,filter_query:"",filter_resolution_status:"",filter_from_date:"",filter_to_date:"",filter_hold:0,filter_premium_user:0,filter_vetted:"",$filter_widget_content:null,$filter_form:null,$filter_query:null,$filter_from_date:null,$filter_to_date:null,$filter_resolution_status:null,$filter_scam_type:null,$filter_who_type:null,$filter_hold:null,$filter_premium_user:null,$custom_filter_box:null,$custom_filter_text:null,current_custom_filter:"",current_custom_filter_id:0,$tbody:null,$pagination:null,$current_paging_button:null,$first_paging_button:null,$report_dialog:null,$previous_report_dialog_button:null,$next_report_dialog_button:null,$close_report_dialog_button:null,$save_report_dialog_button:null,$statistics_dialog_recalculate_button:null,dialog_report_id:0,previous_dialog_report_id:0,next_dialog_report_id:0,dialog_report_ajax_request:null,current_report_dialog_tab_index:0,report_dialog_changes_made:!1,is_saving_report_dialog:!1,TAB_INFO:0,TAB_DETAILS:1,TAB_COMMENTS:2,TAB_COMPLIANCE:3,TAB_MEDIA:4,TAB_FOLLOW_UPS:5,TAB_VOTES:6,TAB_PAYOUT:7,TAB_COMPANY:8,TAB_HISTORY:9,_init:function(){$.uniform.restore("select");this.binds()},binds:function(){var e=this;e.$filter_widget_content=$("#filter_widget_content");e.$filter_form=$("#filter_form");e.$filter_query=$("#filter_query");e.$filter_from_date=$("#filter_from_date");e.$filter_to_date=$("#filter_to_date");e.$filter_scam_type=$("#filter_scam_type");e.$filter_who_type=$("#filter_who_type");e.$filter_resolution_status=$("#filter_resolution_status");e.$filter_hold=$("#filter_hold");e.$filter_premium_user=$("#filter_premium_user");e.$custom_filter_box=$("#custom_filter_box");e.$custom_filter_text=$("#custom_filter_text");e.$tbody=$("#reports_tbody");e.$pagination=$("#pagination_container");e.$current_paging_button=$(".dataTables_paginate a:eq(0)");e.$first_paging_button=e.$current_paging_button;e.$filter_query.keyup(function(t){e.filter_query=t.target.value;e.refresh_reports(e.$first_paging_button)});e.$filter_resolution_status.change(function(t){e.filter_resolution_status=t.target.value;e.refresh_reports(e.$first_paging_button)});$(".page_button").live("click",function(t){e.$current_paging_button=$(this);t.preventDefault();e.refresh_reports(e.$current_paging_button)});e.$report_dialog=$("#report_dialog");e.$report_dialog.dialog({autoOpen:!1,width:1020,height:600,modal:!0,buttons:{Previous:function(){e.load_report(e.previous_dialog_report_id)},Next:function(){e.load_report(e.next_dialog_report_id)},Save:function(){e.save_report_dialog()},Close:function(){$(this).dialog("close")}},open:function(t,n){e.$previous_report_dialog_button=$(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Previous")');e.$previous_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled");e.$next_report_dialog_button=$(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Next")');e.$next_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled");e.$close_report_dialog_button=$(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Close")');e.$save_report_dialog_button=$(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Save")');e.$save_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled");e.load_report(e.dialog_report_id,e.current_report_dialog_tab_index)},beforeClose:function(){e.report_dialog_changes_made&&confirm("You have unsaved changes! Do you want to save before closing?")&&e.save_report_dialog()},close:function(){e.dialog_report_id=0;e.report_dialog_changes_made=!1;e.current_report_dialog_tab_index=0}});$("#statistics_dialog").dialog({width:700,height:475,autoOpen:!1,resizable:!1,open:function(){e.$statistics_dialog_recalculate_button=$(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Recalculate")');e.refresh_statistics_dialog(!1)},buttons:{Recalculate:function(){e.$statistics_dialog_recalculate_button.children(".ui-button-text").html("Recalculating...");e.refresh_statistics_dialog(!0)}}});$("#statistics").click(function(){$("#statistics_dialog").dialog("open")});$("#filter_from_date, #filter_to_date, #filter_scam_type, #filter_who_type").live("change",function(t){t.target.id==="filter_from_date"?e.filter_from_date=t.target.value:t.target.id==="filter_to_date"?e.filter_to_date=t.target.value:t.target.id==="filter_scam_type"?e.filter_scam_type=t.target.value:t.target.id==="filter_who_type"&&(e.filter_who_type=t.target.value);e.refresh_reports(e.$first_paging_button)});$("#filter_hold, #filter_premium_user").change(function(t){var n=t.target.getAttribute("id");n==="filter_hold"?e.filter_hold=t.target.checked?1:0:n==="filter_premium_user"&&(e.filter_premium_user=t.target.checked?1:0);e.refresh_reports(e.$first_paging_button)});$('input[type=radio][name="vetted"]').change(function(t){e.filter_vetted=t.target.value;e.refresh_reports(e.$first_paging_button)});e.refresh_reports(e.$first_paging_button,!0)},refresh_statistics_dialog:function(e){var t=this,e=e||!1;$("#stats_dialog_loader").show();$.ajax({url:"/ajax_reports_statistics_dialog",type:"GET",data:{recalculate:e?1:0},dataType:"json",success:function(e){$("#stats_dialog_loader").hide();$("#statistics_dialog_content").html(e.data.html);$("#statistics_tabs").tabs({selected:0}).bind("tabsshow",function(t,n){if(n.index===2){var r=[];for(var i=0,s=e.data.heatmap_data.length;i<s;i++)r.push(new google.maps.LatLng(e.data.heatmap_data[i].lat,e.data.heatmap_data[i].lng));var o=new google.maps.Map(document.getElementById("stats_map"),{center:new google.maps.LatLng(0,0),zoom:1,minZoom:1,mapTypeId:google.maps.MapTypeId.SATELLITE,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE},scaleControl:!0,panControl:!1,mapTypeControl:!1}),u=new google.maps.visualization.HeatmapLayer({data:r});u.setMap(o)}});t.$statistics_dialog_recalculate_button.children(".ui-button-text").html("Recalculate");$("#reports_stats_chart").highcharts({chart:{width:620,height:150},title:{text:""},xAxis:{categories:months},yAxis:{title:{text:"Reports"},min:0},legend:{enabled:!1},credits:{enabled:!1},series:[{data:num_reports}]})}})},refresh_reports:function(e,t){var n=this,r=!$sb.empty(e)&&e.attr("data-page_number")?e.attr("data-page_number"):"1";t=t||!1;n.table_ajax_request!==null&&n.table_ajax_request.abort();n.$tbody.html('<tr><td id="reports_table_loader" colspan="6"></td></tr>');n.table_ajax_request=$.getJSON("/ajax_get_reports/"+r,{custom_filter:n.current_custom_filter,custom_filter_id:n.current_custom_filter_id,filter_query:n.filter_query,filter_resolution_status:n.filter_resolution_status,filter_from_date:n.filter_from_date,filter_to_date:n.filter_to_date,filter_scam_type:n.filter_scam_type,filter_who_type:n.filter_who_type,filter_hold:n.filter_hold,filter_premium_user:n.filter_premium_user,filter_vetted:n.filter_vetted},function(e){n.$tbody.html(e.data.html);n.$pagination.html(e.data.pagination);$(".view").click(function(e){n.dialog_report_id=$(this).attr("data-report_id");n.$report_dialog.dialog("open")});$(".details").click(function(){n.dialog_report_id=$(this).attr("data-report_id");n.current_report_dialog_tab_index=n.TAB_DETAILS;n.$report_dialog.dialog("open")});$(".comments").click(function(){n.dialog_report_id=$(this).attr("data-report_id");n.current_report_dialog_tab_index=n.TAB_COMMENTS;n.$report_dialog.dialog("open")});$("#clear_custom_filter").click(function(){n.$custom_filter_box.hide();n.$filter_widget_content.removeClass("custom-filter");n.$filter_form.show();n.current_custom_filter="";n.current_custom_filter_id=0;n.refresh_reports(n.$first_paging_button)});$(".filter-company-complaints").click(function(){var e=$(this).attr("data-company_id"),t=$(this).attr("data-company_name");n.$filter_form.hide();n.$filter_widget_content.addClass("custom-filter");n.$custom_filter_box.show();n.$custom_filter_text.html("Showing all complaints against "+t);n.current_custom_filter="company";n.current_custom_filter_id=e;n.refresh_reports(n.$first_paging_button)});$(".filter-user-complaints").click(function(){var e=$(this).attr("data-user_id"),t=$(this).attr("data-user_name");n.$filter_form.hide();n.$filter_widget_content.addClass("custom-filter");n.$custom_filter_box.show();n.$custom_filter_text.html("Showing all complaints from "+t);n.current_custom_filter="user";n.current_custom_filter_id=e;n.refresh_reports(n.$first_paging_button)});$(".delete").click(function(){var e=$(this),t=e.attr("data-id");e.html("Deleting...").attr("disabled",!0);$.alert({type:"confirm",title:"Are you sure you want to delete?",text:"<p>Are you sure you want to deleted the report #"+t+"?</p>",callback:function(){$.ajax({url:"/ajax_save_report",type:"POST",data:{id:t,active:0,deleted:1},dataType:"json",success:function(e){n.refresh_reports(n.$current_paging_button)}})}})})}).fail(function(){n.$tbody.html('<tr><td id="failed_to_load" colspan="6">Could not load reports.</td></tr>')})},load_report:function(e,t){var n=this;n.$report_dialog.dialog("option","title","View Report #"+e);n.dialog_report_ajax_request!==null&&n.dialog_report_ajax_request.abort();n.$report_dialog.html('<span id="report_dialog_loader"></span>');n.dialog_report_ajax_request=$.getJSON("/ajax_get_report",{id:e},function(e){if(e.data.error===""){n.previous_dialog_report_id=e.data.previous_report_id;n.next_dialog_report_id=e.data.next_report_id;n.$report_dialog.html(e.data.html);t!==undefined?$("#report_dialog_tabs").tabs({selected:t}):$("#report_dialog_tabs").tabs({});$("#report_dialog_tabs").bind("tabsshow",function(e,t){n.current_report_dialog_tab_index=t.index});$("#report_dialog_tabs ul li a").eq(n.TAB_COMMENTS).text("Comments"+(e.data.num_comments>0?" ("+e.data.num_comments+")":""));e.data.num_comments===0&&$("#report_dialog_tabs").tabs("disable",n.TAB_COMMENTS);$("#report_dialog_tabs ul li a").eq(n.TAB_MEDIA).text("Media"+(e.data.num_media>0?" ("+e.data.num_media+")":""));e.data.num_media===0&&$("#report_dialog_tabs").tabs("disable",n.TAB_MEDIA);$("#report_dialog_tabs ul li a").eq(n.TAB_FOLLOW_UPS).text("Follow Ups"+(e.data.num_follow_ups>0?" ("+e.data.num_follow_ups+")":""));e.data.num_follow_ups===0&&$("#report_dialog_tabs").tabs("disable",n.TAB_FOLLOW_UPS);$("#report_dialog_tabs ul li a").eq(n.TAB_VOTES).text("Votes"+(e.data.num_votes>0?" ("+e.data.num_votes+")":""));e.data.num_votes===0&&$("#report_dialog_tabs").tabs("disable",n.TAB_VOTES);$("#report_dialog_tabs ul li a").eq(n.TAB_PAYOUT).text("Payout");e.data.have_payout||$("#report_dialog_tabs").tabs("disable",n.TAB_PAYOUT);$("#report_dialog_tabs ul li a").eq(n.TAB_HISTORY).text("History"+(e.data.num_history_items>0?" ("+e.data.num_history_items+")":""));n.previous_dialog_report_id>0?n.$previous_report_dialog_button.removeAttr("disabled",!0).removeClass("ui-state-disabled"):n.$previous_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled");n.next_dialog_report_id>0?n.$next_report_dialog_button.removeAttr("disabled",!0).removeClass("ui-state-disabled"):n.$next_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled");$("#who_type").change(function(e){n.report_dialog_changes_made=!0;n.$save_report_dialog_button.removeAttr("disabled",!0).removeClass("ui-state-disabled")});$("#report_dialog_active, #report_dialog_deleted, #report_dialog_hold").change(function(){n.report_dialog_changes_made=!0;n.$save_report_dialog_button.removeAttr("disabled",!0).removeClass("ui-state-disabled")});$("#change_details").click(function(){$("#report_dialog_tabs").tabs("select",n.TAB_DETAILS);$("#report_dialog_details").focus()});$("#report_dialog_details").keyup(function(e){if(n.report_dialog_changes_made)return;var t=String.fromCharCode(e.keyCode);if(/[a-zA-Z0-9-_ ]/.test(t)||e.keyCode===8||e.keyCode===46){n.report_dialog_changes_made=!0;n.$save_report_dialog_button.removeAttr("disabled",!0).removeClass("ui-state-disabled")}});$("#report_dialog_details").change(function(e){if(n.report_dialog_changes_made)return;n.report_dialog_changes_made=!0;n.$save_report_dialog_button.removeAttr("disabled",!0).removeClass("ui-state-disabled")});$("#undo_compliance").click(function(){$(this).html("Undoing...").attr("disabled",!0);var e=$(this).attr("data-report_compliance_id");$.ajax({url:"/ajax_undo_compliance",type:"POST",data:{id:e},dataType:"json",success:function(e){n.load_report(n.dialog_report_id,n.TAB_COMPLIANCE);n.refresh_reports(n.$current_paging_button)}})});$('input[name="decision"]').change(function(e){var t=e.target.value;if(t==="approve"){$("#deny_decision_box, #need_review_decision_box").hide();$("#approve_decision_box").show()}else if(t==="deny"){$("#approve_decision_box, #need_review_decision_box").hide();$("#deny_decision_box").show()}else if(t==="need_review"){$("#approve_decision_box, #deny_decision_box").hide();$("#need_review_decision_box").show()}});$("#compliance_form").submit(function(){var e=$('input[name="decision"]:checked').val(),t="";if(e==="approve"){t=$("#approve_decision").val();$("#approve_compliance_submit").val("Approving...").attr("disabled",!0)}else if(e==="deny"){t=$("#deny_decision").val();$("#deny_compliance_submit").val("Denying...").attr("disabled",!0)}else e==="need_review"&&$("#need_review_compliance_submit").val("Submitting...").attr("disabled",!0);$.ajax({url:"/ajax_report_compliance",data:{id:n.dialog_report_id,decision:e,reason:t},type:"POST",dataType:"json",success:function(e){n.load_report(n.dialog_report_id,n.TAB_COMPLIANCE);n.refresh_reports(n.$current_paging_button)}});return!1});$(".make-media-private, .make-media-public").click(function(){var e=$(this).attr("data-id"),t=$(this).attr("data-what");t==="public"?$.alert({type:"confirm",title:"Make media public?",text:"<p>Are you sure you want to make media public?</p>",callback:function(){$.post("/ajax_media_update_visibility",{id:e,set_to:"public"},function(e){n.load_report(n.dialog_report_id,n.TAB_MEDIA)})}}):t==="private"&&$.alert({type:"confirm",title:"Make media private?",text:"<p>Are you sure you want to make media private?</p>",callback:function(){$.post("/ajax_media_update_visibility",{id:e,set_to:"private"},function(e){n.load_report(n.dialog_report_id,n.TAB_MEDIA)})}})});$('input[type="radio"][name="consolidate"]').click(function(e){$(".consolidate-container").hide();switch(e.target.value){case"consolidate_to_another_company":$("#consolidate_to_another_company_container").show();$("#consolidate_to_another_company_company_name").focus();break;default:$("#"+e.target.value+"_container").show()}});$("#consolidate_to_another_company_company_name, #consolidate_other_companies_to_this_company_name, #move_to_another_company_company_name").autocomplete({source:"/ajax_get_companies_autocomplete"});$("#consolidate_form").submit(function(){var e=$('input[type="radio"][name="consolidate"]:checked').val();if(e==="consolidate_to_another_company"){var t=$("#consolidate_to_another_company_company_name").val();if(!t){$("#consolidate_to_another_company_error").html("Select company!").show().delay(3e3).queue(function(e){$(this).fadeOut("fast");e()});$("#consolidate_to_another_company_company_name").focus();return!1}$("#consolidate_to_another_company_submit").attr("disabled",!0).val("Consolidating...");$.ajax({url:"/ajax_consolidate_to_another_company",data:{report_id:n.dialog_report_id,company_name:t,change_seo:$("#consolidate_to_another_company_change_seo_company").is(":checked")?1:0},type:"POST",dataType:"json",success:function(e){if(e.data.error===""){$.jGrowl(e.data.success,{theme:"success",sticky:!0});n.load_report(n.dialog_report_id,n.TAB_COMPANY)}else{$("#consolidate_to_another_company_error").html(e.data.error).show().delay(3e3).queue(function(e){$(this).fadeOut("fast");e()});$("#consolidate_to_another_company_submit").removeAttr("disabled").val("Consolidate")}}})}else if(e==="consolidate_other_companies_to_this"){var t=$("#consolidate_other_companies_to_this_company_name").val();if(!t){$("#consolidate_other_companies_to_this_error").html("Select company!").show().delay(3e3).queue(function(e){$(this).fadeOut("fast");e()});$("#consolidate_other_companies_to_this_company_name").focus();return!1}$("#consolidate_other_companies_to_this_submit").attr("disabled",!0).val("Consolidating...");$.ajax({url:"/ajax_consolidate_other_companies_to_this",data:{report_id:n.dialog_report_id,company_name:t,change_seo:$("#consolidate_other_companies_to_this_change_seo_company").is(":checked")?1:0},type:"POST",dataType:"json",success:function(e){if(e.data.error===""){$.jGrowl(e.data.success,{theme:"success",sticky:!0});n.load_report(n.dialog_report_id,n.TAB_COMPANY)}else{$("#consolidate_other_companies_to_this_error").html(e.data.error).show().delay(3e3).queue(function(e){$(this).fadeOut("fast");e()});$("#consolidate_other_companies_to_this_submit").removeAttr("disabled").val("Consolidate")}}})}else if(e==="move_to_another_company"){var t=$("#move_to_another_company_company_name").val();if(!t){$("#move_to_another_company_error").html("Select company!").show().delay(3e3).queue(function(e){$(this).fadeOut("fast");e()});$("#move_to_another_company_company_name").focus();return!1}$("#move_to_another_company_submit").attr("disabled",!0).val("Moving...");$.ajax({url:"/ajax_report_move_to_another_company",data:{report_id:n.dialog_report_id,company_name:t,update_seo:$("#move_to_another_company_update_seo_company").is(":checked")?1:0},type:"POST",dataType:"json",success:function(e){if(e.data.error===""){$.jGrowl(e.data.success,{theme:"success",sticky:!0});n.load_report(n.dialog_report_id,n.TAB_INFO)}else{$("#move_to_another_company_error").html(e.data.error).show().delay(3e3).queue(function(e){$(this).fadeOut("fast");e()});$("#move_to_another_company_submit").removeAttr("disabled").val("Move")}}})}return!1});$(".deconsolidate").click(function(){var e=$(this),t=e.attr("data-id"),n=e.attr("data-name");$.alert({type:"confirm",title:"Are you sure?",text:'<p>Are you sure you want to deconsolidate company "'+n+'"?</p>',callback:function(){e.html("Deconsolidating...");$.ajax({url:"/deconsolidate_company",type:"POST",data:{id:t},dataType:"json",success:function(n){if(n.data.error===""){$("#consolidated_company_"+t).fadeOut();var r=parseInt($("#num_consolidated_companies").html(),null);$("#num_consolidated_companies").html(r-1)}else{e.html("Deconsolidate");$.jGrowl(n.data.error,{theme:"error",sticky:!0})}}})}})});$(".the-image a").fancybox({overlayShow:!1})}else alert(e.data.error)})},save_report_dialog:function(){var e=this;e.$save_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled").children(".ui-button-text").html("Saving...");e.$close_report_dialog_button.attr("disabled",!0).addClass("ui-state-disabled");e.is_saving_report_dialog=!0;$("#who_type, #report_dialog_details, #report_dialog_active, #report_dialog_deleted, #report_dialog_hold").attr("disabled",!0);$.when($.ajax({url:"/ajax_save_who_type",type:"POST",data:{id:e.dialog_report_id,new_who_type:$("#who_type").val()},dataType:"json"}),$.ajax({url:"/ajax_save_report",type:"POST",data:{id:e.dialog_report_id,details:$("#report_dialog_details").val(),active:$("#report_dialog_active").is(":checked")?1:0,deleted:$("#report_dialog_deleted").is(":checked")?1:0,hold:$("#report_dialog_hold").is(":checked")?1:0},dataType:"json"})).done(function(){e.is_saving_report_dialog=!1;e.report_dialog_changes_made=!1;e.$save_report_dialog_button.children(".ui-button-text").html("Save");e.$close_report_dialog_button.removeAttr("disabled").removeClass("ui-state-disabled");$("#who_type, #report_dialog_details, #report_dialog_active, #report_dialog_deleted, #report_dialog_hold").removeAttr("disabled");e.refresh_reports(e.$current_paging_button)})}};$sb.crm.Reports=new Reports;$(document).ready(function(){$sb.crm.Reports._init()});