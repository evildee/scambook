function Premium_User_Accounts(){}Premium_User_Accounts.prototype={search_term:"",selected_status:"",selected_user_status:"",selected_from_date:"",selected_to_date:"",$clear_filter_field:null,search_regular_users_only:!1,search_called_only:!1,$status_field:null,$user_status_field:null,$from_date_field:null,$to_date_field:null,num_payment_fails:"",current_sort_field:"created",current_sort_order:"desc",table_ajax_request:null,$user_accounts_table:null,$tbody:null,$users_table:null,$tbody_users:null,$pagination:null,$view_dialog:null,$current_paging_button:null,$first_paging_button:null,view_user_account_id:0,view_user_id:0,dialog_tab_index_to_select:0,doing_user_stripe_lookup:!1,is_refunding:!1,selected_stripe_id:"",$stats_content:null,updating_last_called:!1,update_tracking_code_button:null,changes_made:!1,_init:function(){this.binds()},binds:function(){var e=this;e.$status_field=$("#status_field");e.$user_status_field=$("#user_status_field");e.$from_date_field=$("#from_date_field");e.$to_date_field=$("#to_date_field");e.$current_paging_button=$(".dataTables_paginate a:eq(0)");e.$first_paging_button=e.$current_paging_button;$clear_filter_field=$("#clear_filter_field");$("#search_term").keyup(function(t){e.search_term=t.target.value;e.check_clear_button();e.search_regular_users_only?e.refresh_users_table(e.$first_paging_button):e.refresh_user_accounts_table(e.$first_paging_button,!0)});$("#status").live("change",function(t){e.selected_status=t.target.value;e.check_clear_button();e.refresh_user_accounts_table(e.$first_paging_button)});$("#user_status").live("change",function(t){e.selected_user_status=t.target.value;e.check_clear_button();e.refresh_users_table(e.$first_paging_button)});$("#from_date, #to_date").live("change",function(t){t.target.id==="from_date"?e.selected_from_date=t.target.value:t.target.id==="to_date"&&(e.selected_to_date=t.target.value);e.check_clear_button();e.search_regular_users_only?e.refresh_users_table():e.refresh_user_accounts_table(e.$first_paging_button)});$("#clear_filter_button").live("click",function(){$("#search_term").val("");e.search_term="";$("#status").val("");$.uniform.update("#status");e.selected_status="";$("#user_status").val("");$.uniform.update("#user_status");e.selected_user_status="";$("#from_date").val("");e.selected_from_date="";$("#to_date").val("");e.selected_to_date="";$("#search_regular_users_only").removeAttr("checked");$.uniform.update("#search_regular_users_only");$clear_filter_field.hide();e.refresh_user_accounts_table(e.$first_paging_button)});$(".sortable-th").live("click",function(){var t=$(this).attr("data-sort");if(t===e.current_sort_field)e.current_sort_order=e.current_sort_order==="asc"?"desc":"asc";else{e.current_sort_order="asc";$("#"+e.current_sort_field+"_sort_icon").addClass("hidden");$("#"+t+"_sort_icon").removeClass("hidden")}$("#"+e.current_sort_field+"_th").removeClass("active");$(".icon").not("#"+t+"_sort_icon").removeClass("active");e.current_sort_field=t;var n=$("#"+t+"_sort_icon");$("#"+t+"_th").addClass("active");n.addClass("active");if(e.current_sort_order==="asc"){n.removeClass("desc");n.addClass("asc")}else{n.removeClass("asc");n.addClass("desc")}e.refresh_user_accounts_table(e.$first_paging_button)});e.$user_accounts_table=$("#premium_user_accounts_table");e.$tbody=$("#premium_user_accounts_tbody");e.$users_table=$("#users_table");e.$tbody_users=$("#users_tbody");e.$pagination=$("#pagination_container");$(".page_button").live("click",function(t){e.$current_paging_button=$(this);t.preventDefault();e.search_regular_users_only?e.refresh_users_table($(this)):e.refresh_user_accounts_table($(this))});$(".approve").live("click",function(){var t=$(this).attr("data-id");e.approve(t,!1)});$(".deny").live("click",function(){var t=$(this).attr("data-id");e.deny(t,!1)});e.$view_dialog=$("#view_dialog");e.$view_dialog.dialog({autoOpen:!1,width:860,height:620,modal:!0,buttons:{Save:function(){e.save_user_account_dialog();$(this).dialog("close")},Close:function(){e.changes_made?e.close_dialog():$(this).dialog("close")}},open:function(t,n){e.$view_dialog.dialog("option","title","View Premium User Account #"+e.view_user_account_id);e.$view_dialog.html('<span id="dialog_loader"></span>');$("#user_account_"+e.view_user_account_id).addClass("opened");$.getJSON("/ajax_get_user_account",{id:e.view_user_account_id},function(t){e.$view_dialog.html(t.html);$("#user_account_dialog_tabs").tabs({create:function(e,t){$("#call_script_tabs").tabs()},selected:e.dialog_tab_index_to_select}).bind("tabsshow",function(t,n){switch(n.index){case 5:var r=$("#tab_stripe");e.selected_stripe_id=r.attr("data-stripe_id");e.user_stripe_lookup(e.view_user_account_id,e.selected_stripe_id);break;case 6:}})})},close:function(){$("#user_account_"+e.view_user_account_id).removeClass("opened");e.dialog_tab_index_to_select=0;e.changes_made=!1}});e.$view_user_dialog=$("#view_user_dialog");e.$view_user_dialog.dialog({autoOpen:!1,width:860,height:700,modal:!0,buttons:{Close:function(){$(this).dialog("close")}},open:function(t,n){e.$view_user_dialog.dialog("option","title","View User #"+e.view_user_id);e.$view_user_dialog.html('<span id="dialog_loader"></span>');$("#user_"+e.view_user_id).addClass("opened");$.getJSON("/ajax_get_user",{id:e.view_user_id},function(t){e.$view_user_dialog.html(t.html);$("#user_dialog_tabs").tabs({create:function(e,t){$("#user_call_script_tabs").tabs()},selected:e.dialog_tab_index_to_select})})},close:function(){$("#user_"+e.view_user_id).removeClass("opened");e.dialog_tab_index_to_select=0}});$(".delete").live("click",function(){var t=$(this).attr("data-id");e.delete(t,!1)});$(".cancel").live("click",function(){var t=$(this).attr("data-id"),n=$(this).attr("data-refund")==1?!0:!1;e.cancel(t,n,!1)});$(".ui-widget-overlay").live("click",function(){e.$view_dialog.dialog("close");e.$view_user_dialog.dialog("close")});$(".view").live("click",function(){var t=$(this).attr("data-id");e.view_user_account(t)});$(".view-user").live("click",function(){var t=$(this).attr("data-id");e.view_user(t)});$(".show-more-complaints").live("click",function(){var t=$(this).attr("data-id");e.view_user_account(t,2)});$(".user-account-user-info").live("click",function(){var t=$(this).attr("data-id");e.view_user_account(t,1)});$(".user-info").live("click",function(){var t=$(this).attr("data-id");e.view_user(t,1)});$(".take-over").live("click",function(){var t=$(this).attr("data-user_id"),n=$(this).attr("href");e.take_over(t,n,!1);return!1});$(".refund").live("click",function(){if(e.is_refunding===!0)return;var t=$(this).attr("data-charge_id"),n=$(this).attr("data-amount");e.refund($(this),t,n,!1)});$(".offer").live("click",function(){var t=$(this).attr("data-id");e.offer(t,!1)});e.$stats_content=$("#stats_content");$("#refresh_stats").click(function(){e.search_regular_users_only?e.refresh_users_table(e.$current_paging_button):e.refresh_user_accounts_table(e.$current_paging_button,!0);e.refresh_stats(!0)});$(".goto-call-script").live("click",function(){var e=$(this).attr("data-report_id");$("#user_dialog_tabs").tabs("select",2);$("#user_account_dialog_tabs").tabs("select",3);var t=$('#call_script_tabs a[href="#tab_call_script_'+e+'"]').parent().index();$("#call_script_tabs").tabs("select",t)});$("#premium_user_accounts_table th").hover(function(){$(this).children("a").addClass("over")},function(){$(this).children("a").removeClass("over")});$("#search_regular_users_only").click(function(t){e.table_ajax_request!=null&&e.table_ajax_request.abort();e.search_regular_users_only=t.target.checked;if(e.search_regular_users_only){e.$status_field.hide();e.$user_status_field.show();e.$from_date_field.hide();e.$to_date_field.hide();e.refresh_users_table(e.$first_paging_button)}else{e.$user_status_field.hide();e.$status_field.show();e.$from_date_field.show();e.$to_date_field.show();e.refresh_user_accounts_table(e.$first_paging_button,!0)}e.check_clear_button()});$("#update_last_called").live("click",function(){if(e.updating_last_called===!0)return;var t=$(this),n=t.attr("data-user_id");e.updating_last_called=!0;t.text("Updating...");$sb.ajax.post("/ajax_update_last_called",{id:n},function(n){$("#last_called").html(n.data.last_called);t.text("Update");e.updating_last_called=!1})});$("#search_called_only").click(function(t){e.search_called_only=t.target.checked;e.search_regular_users_only?e.refresh_users_table(e.$first_paging_button):e.refresh_user_accounts_table(e.$first_paging_button,!0)});$("#premium_user_accounts_table .print-mailer").live("click",function(){var t=$(this).attr("data-report_id");$.alert({type:"confirm",title:"Set As Printed?",text:"<p>Do you want to set mailer as printed for complaint #"+t+"?</p>",callback:function(){$sb.ajax.post("/ajax_set_mailer_as_printed",{report_id:t},function(t){e.refresh_user_accounts_table(e.$current_paging_button)})}})});$("#general_form").live("submit",function(){alert("yo bro");return!1});$('#notes, input[name="tracking_code[]"]').live("keyup",function(){e.changes_made=!0});$("#num_payment_fails").change(function(t){e.num_payment_fails=t.target.value;e.refresh_user_accounts_table(e.$first_paging_button)});e.refresh_user_accounts_table(e.$first_paging_button);e.refresh_stats()},refresh_user_accounts_table:function(e,t){var n=this;if($sb.empty(e))return!1;var r=e.attr("data-page_number");r||(r="1");if(!$sb.empty(r)){n.show_table_loader();n.table_ajax_request!=null&&n.table_ajax_request.abort();n.table_ajax_request=$.getJSON("/premium_user_accounts/"+r,{search_term:n.search_term,status:n.selected_status,from_date:n.selected_from_date,to_date:n.selected_to_date,sort_field:n.current_sort_field,sort_order:n.current_sort_order,search_for_users:n.search_for_users,search_called_only:n.search_called_only?1:0,num_payment_fails:n.num_payment_fails},function(e){n.table_ajax_request=null;typeof e.html.results!="undefined"&&n.$tbody.html(e.html.results);typeof e.html.pagination!="undefined"&&n.$pagination.html(e.html.pagination);e.html.data.num_user_accounts==0&&t===!0&&n.refresh_users_table(n.$first_paging_button,!0)})}},refresh_users_table:function(e,t){var n=this;if($sb.empty(e))return!1;typeof t=="undefined"&&(t=!1);var r=e.attr("data-page_number");r||(r="1");if(!$sb.empty(r)){n.show_users_table_loader(t);n.table_ajax_request!=null&&n.table_ajax_request.abort();n.table_ajax_request=$.getJSON("/ajax_search_users/"+r,{search_term:n.search_term,status:n.selected_user_status,search_called_only:n.search_called_only?1:0},function(e){n.table_ajax_request=null;if(e.html.data.num_users>0){typeof e.html.results!="undefined"&&n.$tbody_users.html(e.html.results);typeof e.html.pagination!="undefined"&&n.$pagination.html(e.html.pagination)}else n.$tbody_users.html('<tr><td colspan="6"><span style="float:left;width:100%;margin-top:190px;text-align:center">No regular users found.</span></td></tr>')})}},show_table_loader:function(){this.$users_table.hide();this.$user_accounts_table.show();this.$tbody.html('<tr><td colspan="6"><span style="float:left;width:100%;margin-top:190px;text-align:center">Searching for Premium User Accounts...</span><br><div class="loader"></div></td></tr>')},show_users_table_loader:function(e){typeof e=="undefined"&&(e=!1);this.$user_accounts_table.hide();this.$users_table.show();this.$tbody_users.html('<tr><td colspan="6"><span style="float:left;width:100%;margin-top:190px;text-align:center">'+(e?"No Premium User Accounts found. ":"")+'Searching for regular users...</span><br><div class="loader"></div></td></tr>')},approve:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Are you sure you want to approve user account?</p>",callback:function(){n.approve(e,!0)}});return}$("#manage_buttons_"+e).html("Approving...");$sb.ajax.post("/ajax_update_user_account",{id:e,action:"approve"},function(){n.refresh_user_accounts_table(n.$current_paging_button)})},deny:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Are you sure you want to deny user account?</p>",callback:function(){n.deny(e,!0)}});return}$("#manage_buttons_"+e).html("Denying...");$sb.ajax.post("/ajax_update_user_account",{id:e,action:"deny"},function(){n.refresh_user_accounts_table(n.$current_paging_button)})},view_user_account:function(e,t){typeof t!="undefined"&&(this.dialog_tab_index_to_select=t);this.view_user_account_id=e;this.$view_dialog.dialog("open")},view_user:function(e,t){typeof t!="undefined"&&(this.dialog_tab_index_to_select=t);this.view_user_id=e;this.$view_user_dialog.dialog("open")},"delete":function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Are you sure?",text:'<p>Are you sure you want to delete user account "'+e+'"?</p>',callback:function(){n.delete(e,!0)}});return}$("#manage_buttons_"+e).html("Deleting...");$sb.ajax.post("/ajax_update_user_account",{id:e,action:"delete"},function(){n.refresh_user_accounts_table(n.$current_paging_button)})},cancel:function(e,t,n){var r=this;if(!n){$.alert({type:"confirm",title:"Are you sure?",text:'<p>Are you sure you want to cancel user account "'+e+'"?</p>',callback:function(){r.cancel(e,t,!0)}});return}$("#manage_buttons_"+e).html("Cancelling...");$sb.ajax.post("/ajax_update_user_account",{id:e,action:"cancel",refund:t},function(){r.refresh_user_accounts_table(r.$current_paging_button)})},user_stripe_lookup:function(e,t){var n=this;if(n.doing_user_stripe_lookup===!0)return;$("#tab_stripe .loader").show();n.doing_user_stripe_lookup=!0;$("#stripe_user_lookup_content").html("");$("#stripe_user_lookup").text("Getting info from Stripe...");$sb.ajax.get("/ajax_user_stripe_lookup",{user_account_id:e,stripe_id:t},function(e){$("#tab_stripe .loader").hide();if(typeof e.errors=="undefined"){$("#stripe_user_lookup_content").html(e.data.html);e.data.customer!=null?$("#stripe_user_lookup").hide():$("#stripe_user_lookup_content").html('<span class="no-customer">Customer not found in Stripe.</span>')}else $("#stripe_user_lookup_content").html('<span class="error">'+e.errors.error+"</span>");$("#stripe_user_lookup").text("Stripe Lookup");n.doing_user_stripe_lookup=!1})},take_over:function(e,t,n){var r=this;if(!n){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Are you sure you want to take over user?</p>",callback:function(){r.take_over(e,t,!0)}});return}document.location=t},offer:function(e,t){var n=this;if(!t){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Are you sure you want to offer user #"+e+" a 30-Day Premium User Account Trial?</p>",callback:function(){n.offer(e,!0)}});return}$("#manage_buttons_"+e).html("Offering...");$sb.ajax.post("/ajax_offer_trial",{id:e},function(){n.refresh_users_table(n.$current_paging_button)})},refresh_stats:function(e){var t=this;t.$stats_content.html("").addClass("loading");typeof e=="undefined"&&(e=!1);$.getJSON("/ajax_get_premium_user_account_stats",{force_cache_recompile:e},function(e){t.$stats_content.removeClass("loading").html(e.html)})},check_clear_button:function(){$("#search_term").val()!==""||$("#status").val()!==""||$("#user_status").val()!==""||$("#from_date").val()!==""||$("#to_date").val()!==""||$("#search_regular_users_only").is(":checked")?$clear_filter_field.show():$clear_filter_field.hide()},print_mailer:function(e){alert("Print Mailer for Report ID #"+e)},save_user_account_dialog:function(){var e=this,t={};$('input[name="tracking_code[]"]').each(function(e,n){var r=$(n);t[r.attr("data-report_id")]=r.val()});var n=$("#notes").val(),r=!1;$.ajax({url:"/ajax_save_user_account_dialog",type:"POST",data:{user_account_id:e.view_user_account_id,notes:n,tracking_codes:t},async:!1,success:function(e){e=!0}});return r},close_dialog:function(e){var t=this;if(!e){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Changes has been made!<br>Are you sure you want to close the dialog? All changes will be lost.</p>",callback:function(){t.close_dialog(!0)}});return}t.$view_dialog.dialog("close")},refund:function(e,t,n,r){var i=this;if(!r){$.alert({type:"confirm",title:"Are you sure?",text:"<p>Are you sure you want to refund user?</p>",callback:function(){i.refund(e,t,n,!0)}});return}i.is_refunding=!0;e.text("Refunding...");$.post("/ajax_stripe_refund",{user_account_id:i.view_user_account_id,charge_id:t,amount:n},function(e){i.is_refunding=!1;i.user_stripe_lookup(i.view_user_account_id,i.selected_stripe_id)})}};$sb.crm.Premium_User_Accounts=new Premium_User_Accounts;$(document).ready(function(){$sb.crm.Premium_User_Accounts._init()});