// requires: jquery
function edit_company(){}edit_company.prototype={rs:Object,form:Object,country_selector:Object,company_id:0,attach_phone_call_dialog:null,attach_phone_call_tabs:null,selected_phone_calls:[],selected_attach_to:-1,selected_attach_to_str:"",num_init_dialog_players:0,dialog_players:[],report_players:[],company_players:[],first_call_email_dialog:null,$document_upload_progress_bar:null,$document_upload_progress_text:null,$document_upload_info:null,$document_form_fields:null,document_upload_xhr:null,file_to_upload:null,max_upload_file_size:0,post_max_size:0,$documents_tbody:null,$document_file:null,$num_documents:null,upload_document_dialog:null,edit_document_dialog:null,current_edit_document_id:0,binds:function(){var e=this;e.country_selector.change(function(){e.rs.start(e.form,e.country_selector)});$('button[type="submit"]').unbind("click");$('button[type="submit"]').bind("click",function(){e.check()});$("#tab_phone_call, #edit_company_tabs").tabs();e.attach_phone_call_tabs=$("#attach_phone_call_tabs");e.attach_phone_call_dialog=$("#attach_phone_call_dialog").dialog({autoOpen:!1,width:750,height:470,resizable:!1,buttons:{Close:function(){$(this).dialog("close")}},open:function(){e.attach_phone_call_tabs=$("#attach_phone_call_tabs").tabs({disabled:[1,2]});e.show_attach_phone_loader(1);$sb.ajax.get("/download_phone_calls",{},function(t){var n=t.data.error;if(n===""){$("#attach_phone_call_step1 .inner").html(t.data.html);e.num_init_dialog_players=$("#attach_phone_call_dialog audio").length;for(var r=0;r<e.num_init_dialog_players;r++){e.init_dialog_player(r);$("#dialog_phone_call_"+r).click(function(t){var n=$(t.target);if(t.target.checked)e.selected_phone_calls.push(new e.Phone_Call(t.target.value,n.attr("data-type"),n.attr("data-number"),n.attr("data-time")));else for(var r=0,i=e.selected_phone_calls.length;r<i;r++)if(t.target.value===e.selected_phone_calls[r].filename){e.selected_phone_calls.splice(r,1);break}if(e.selected_phone_calls.length>0){e.attach_phone_call_tabs.tabs("enable",1);$("#next_step1").addClass("btn-primary")}else{e.attach_phone_call_tabs.tabs("disable",1);e.attach_phone_call_tabs.tabs("disable",2);$("#next_step1").removeClass("btn-primary")}})}}else n==="MISSING_EXTENSION"&&$("#attach_phone_call_step1 .inner").html("You doesn't have an extension set yet. Please set an extension before continuing.")})},close:function(){e.pause_dialog_players(-1);e.selected_phone_calls=[];e.selected_attach_to=-1;e.selected_attach_to_str="";e.num_init_dialog_players=0;e.attach_phone_call_tabs.tabs("select",0);e.attach_phone_call_tabs.tabs("option","disabled",[1,2]);e.dialog_players=[];$('input[name="attach_to"]').removeAttr("checked");$("#selected_phone_call_summary, #selected_attach_to_summary").html("")}}).bind("tabsshow",function(t,n){switch(n.index){case 1:typeof $('input[name="attach_to"]:checked').val()!="undefined"&&e.attach_phone_call_tabs.tabs("enable",2);break;case 2:var r=e.selected_phone_calls.length,i="",s=[];e.dialog_players.splice(e.num_init_dialog_players);for(var o=0;o<r;o++){var u=e.dialog_players.length+o;s.push(u);i+='<audio id="dialog_player_'+u+'" src="/play_recording?filename='+e.selected_phone_calls[o].filename+'"></audio>';i+='<a id="dialog_player_play_'+u+'" data-index="'+u+'" class="play"><span class="play-icon"></span></a>';i+='<div class="progress-container">';i+='<progress id="dialog_player_progress_'+u+'" data-index="'+u+'" class="recording-progress" value="0" max="1"></progress>';i+='<span id="dialog_player_buffering_'+u+'" class="buffering"></span>';i+="</div>";i+='<span id="dialog_player_status_'+u+'" class="player-status">Loading...</span><div class="clear"></div>'}$("#selected_phone_call_summary").html(i);$("#selected_attach_to_summary").html(e.selected_attach_to_str);for(var a=0,f=s.length;a<f;a++)e.init_dialog_player(s[a])}});$("#attach_phone_call").click(function(){e.attach_phone_call_dialog.dialog("open")});$("#next_step1").click(function(){if(e.selected_phone_calls.length===0){$("#warning_step1").show().delay(2e3).queue(function(e){$(this).hide();e()});return}e.attach_phone_call_tabs.tabs("select",1)});$('#attach_phone_call_dialog input[name="attach_to"]').live("click",function(t){e.selected_attach_to=t.target.value;e.selected_attach_to_str=$(t.target).parent().children("span").html();e.attach_phone_call_tabs.tabs("enable",2);$("#next_step2").addClass("btn-primary")});$("#next_step2").click(function(){if(e.selected_attach_to===-1){$("#warning_step2").show().delay(2e3).queue(function(e){$(this).hide();e()});return}e.attach_phone_call_tabs.tabs("select",2)});$("#back_step2").click(function(){e.attach_phone_call_tabs.tabs("select",0)});$("#attach").click(function(){var t="",n=-1;if(e.selected_attach_to>0){t="report";n=e.selected_attach_to}else{t="company";n=e.company_id}$sb.ajax.post("/attach_phone_call",{company_id:e.company_id,phone_calls:e.selected_phone_calls,attach_to_what:t,attach_to:n},function(n){var r=e.selected_phone_calls.length;e.attach_phone_call_dialog.dialog("close");var i=$("#num_phone_calls"),s=parseInt(i.html(),null);i.html(s+r);var o=$("#num_"+t+"_phone_calls"),u=parseInt(o.html(),null);o.html(u+r);e.refresh_phone_calls(t,!0)})});$("#back_step3").click(function(){e.attach_phone_call_tabs.tabs("select",1)});$(".de-attach").live("click",function(){var t=$(this),n=t.attr("data-id"),r=t.attr("data-index"),i=t.attr("data-what"),s=t.attr("data-what_id");$.alert({type:"confirm",title:"De-Attach Phone Call",text:"<p>Are you sure you want to de-attach the phone call #"+n+"?</p>",callback:function(){i==="report"?e.report_players.splice(r,1):i==="company"&&e.company_players.splice(r,1);t.text("De-Attaching...");$sb.ajax.post("/deattach_phone_call",{company_id:e.company_id,id:n,what:i,what_id:s},function(n){var r=$("#num_phone_calls"),s=parseInt(r.html(),null),o=$("#num_"+i+"_phone_calls"),u=parseInt(o.html(),null);r.html(s-1);o.html(u-1);t.parents("tr").fadeOut(function(){e.refresh_phone_calls(i,!1)})})}})});$("#attach_phone_call_tabs .play").live("click",function(){var t=parseInt($(this).attr("data-index"),null);e.pause_dialog_players(t);e.pause_company_players(0,"dialog");e.pause_report_players(0,"dialog");if(e.dialog_players[t].paused){e.dialog_players[t].play();$("#dialog_player_play_"+t).html('<span class="pause-icon"></span>')}else{e.dialog_players[t].pause();$("#dialog_player_play_"+t).html('<span class="play-icon"></span>')}return!1});$("#company_phone_calls_container .play, #report_phone_calls_container .play").live("click",function(){var t=parseInt($(this).attr("data-index"),null),n=$(this).attr("data-what"),r=null;if(n==="report")r=e.report_players;else{if(n!=="company"){alert("Please contact Dennis if you see this message, because it's not suppose to show up ;-O");return}r=e.company_players}e.pause_company_players(t,n);e.pause_report_players(t,n);if(r[t].paused){r[t].play();$("#"+n+"_player_play_"+t).html('<span class="pause-icon"></span>')}else{r[t].pause();$("#"+n+"_player_play_"+t).html('<span class="play-icon"></span>')}});$("#attach_phone_call_dialog .recording-progress").live("click",function(t){var n=$(this).attr("data-index"),r=e.init_dialog_player(n);r.currentTime=(t.clientX-$(this).offset().left)/$(this).width()*r.duration});$("#tab_phone_call .recording-progress").live("click",function(t){var n=$(this).attr("data-index"),r=$(this).attr("data-what"),i=e.init_player(n,r);i.currentTime=(t.clientX-$(this).offset().left)/$(this).width()*i.duration});e.first_call_email_dialog=$("#first_call_email_dialog").dialog({autoOpen:!1,width:450,height:200,resizable:!1,buttons:{Save:function(){var t=$("#first_call").val(),n=$("#first_email").val(),r=$("#first_call_email_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Save")');r.attr("disabled",!0).addClass("ui-state-disabled").children(".ui-button-text").html("Saving...");$sb.ajax.post("/set_first_call_email",{company:e.company_id,first_call:t,first_email:n},function(e){if(e.data.error===""){$("#first_call").val(e.data.first_call_response);$("#first_email").val(e.data.first_email_response);$("#first_call_email_status").html('<span class="ticket ticket-success">Saved...</span>').show().delay(1500).queue(function(e){$(this).hide();e()})}else $("#first_call_email_status").html('<span class="error">'+e.data.error+"</span>");r.removeAttr("disabled").removeClass("ui-state-disabled").children(".ui-button-text").html("Save")})},Close:function(){$(this).dialog("close")}}});$("#first_call_email").click(function(){e.first_call_email_dialog.dialog("open")});$("#first_call_email_form, #edit_document_form").submit(function(){return!1});$("#first_call, #first_email").keyup(function(e){var t=e.which;t===13&&$("#first_call_email_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Save")').click()});e.$document_upload_progress_bar=$("#document_upload_progress_bar");e.$document_upload_progress_text=$("#document_upload_progress_text");e.$document_upload_info=$("#document_upload_info");e.$document_form_fields=$("#document_form_fields");e.max_upload_file_size=$("#max_file_size").val();e.post_max_size=$("#post_max_size").val();e.$documents_tbody=$("#documents_tbody");e.$num_documents=$("#num_documents");e.$document_file=$("#document_file");e.upload_document_dialog=$("#upload_document_dialog").dialog({autoOpen:!1,width:475,height:270,resizable:!1,buttons:{Upload:function(){var t=$("#document_title").val(),n=$("#document_description").val(),r=new FormData;r.append("document_file",e.file_to_upload);r.append("company",e.company_id);r.append("document_title",t);r.append("document_description",n);e.document_upload_xhr=new XMLHttpRequest;e.document_upload_xhr.open("POST","/upload_document",!0);e.document_upload_xhr.upload.onprogress=function(t){var n=0;if(t.lengthComputable){n=t.loaded/t.total*100;e.$document_upload_progress_bar.val(n)}e.$document_upload_progress_text.html(n.toFixed(0)+"%")};e.document_upload_xhr.onreadystatechange=function(t){this.readyState===4&&e.init_document_upload(!1)};e.document_upload_xhr.onload=function(){if(this.status===200)try{var t=JSON.parse(this.response);if(t.error!=="")e.$document_upload_info.html('<span class="ticket ticket-important">'+t.error+"</span>");else{$("#upload_document_dialog").dialog("close");var n=parseInt(e.$num_documents.html(),null);e.$num_documents.html(n+1);e.refresh_documents(!1);$("#edit_company_tabs").tabs("select",1)}}catch(r){e.$document_upload_info.html('<span class="ticket ticket-important">Could not parse response.</span>')}};e.document_upload_xhr.send(r);e.$document_form_fields.hide();e.$document_upload_progress_bar.show();e.$document_upload_progress_text.show();$("#cancel_document_upload").show()},Close:function(){$(this).dialog("close")}},open:function(){$("#upload_document_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Upload")').attr("disabled",!0).addClass("ui-state-disabled")},close:function(){typeof document_upload_xhr!="undefined"&&e.document_upload_xhr!==null&&e.document_upload_xhr.readyState!==4&&e.document_upload_xhr.abort()}});e.edit_document_dialog=$("#edit_document_dialog").dialog({autoOpen:!1,width:475,height:280,resizable:!1,buttons:{Save:function(){var t=$("#edit_document_title").val(),n=$("#edit_document_description").val();if(!t)return;$sb.ajax.post("/edit_document",{id:e.current_edit_document_id,title:t,description:n},function(t){e.refresh_documents(!1);$("#edit_document_status").html('<span class="ticket ticket-success">Saved...</span>').show().delay(1500).queue(function(e){$(this).hide();e()})})},Close:function(){$(this).dialog("close")}},open:function(){$("#edit_document_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Save")').attr("disabled",!0).addClass("ui-state-disabled");$("#edit_document_dialog").dialog("option","title","Loading...");$("#edit_document_title, #edit_document_description").attr("disabled",!0);$sb.ajax.get("/get_document",{document:e.current_edit_document_id},function(e){if(e.data.error===""){$("#edit_document_title").val(e.data.document.title);$("#edit_document_description").val(e.data.document.description);$("#edit_document_title, #edit_document_description").removeAttr("disabled");$("#edit_document_dialog").dialog("option","title",'Edit Document "'+e.data.document.title_short+'"');$("#edit_document_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Save")').removeAttr("disabled").removeClass("ui-state-disabled")}})},close:function(){e.current_edit_document_id=0;$("#edit_document_title, #edit_document_description").val("")}});$("#documents_table .edit").live("click",function(){e.current_edit_document_id=$(this).attr("data-document_id");e.edit_document_dialog.dialog("open")});$("#upload_document").click(function(){e.upload_document_dialog.dialog("open")});$("#cancel_document_upload").click(function(){e.document_upload_xhr.abort();e.init_document_upload(!1)});$("#documents_table .delete").live("click",function(){var t=$(this),n=t.attr("data-document_filename"),r=t.attr("data-document_id");$.alert({type:"confirm",title:"Set As Printed?",text:'<p>Are you sure you want to delete the document "'+n+'"?</p>',callback:function(){t.replaceWith("Deleting...");$sb.ajax.post("/delete_document",{document:r},function(t){var n=parseInt(e.$num_documents.html(),null);e.$num_documents.html(n-1);e.refresh_documents(!1)})}})});$("#edit_document_title").keyup(function(e){var t=e.which;t===13&&$("#edit_document_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Save")').click()});e.init_document_upload(!0);e.refresh_documents(!0)},init_document_upload:function(e){var t=this;if(!e){t.$document_file.replaceWith(t.$document_file.clone());t.$document_upload_progress_bar.hide().val(0);t.$document_upload_progress_text.hide().html("");t.$document_upload_info.html("");$("#cancel_document_upload").hide();t.file_to_upload=null;$("#upload_document_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Upload")').attr("disabled",!0).addClass("ui-state-disabled");$("#document_title, #document_description").val("")}document.querySelector("#document_file").addEventListener("change",function(e){t.file_to_upload=this.files[0];var n=t.file_to_upload.size>t.max_upload_file_size||t.file_to_upload.size>t.post_max_size;t.$document_upload_info.html("<strong>File Size:</strong> "+t.format_bytes(t.file_to_upload.size)+(n?'<br><span class="ticket ticket-important">Document is too big. Max document size is '+t.format_bytes(t.max_upload_file_size)+" or "+t.format_bytes(t.post_max_size)+".</span>":""));if(!n){$("#upload_document_dialog").next(".ui-dialog-buttonpane").children(".ui-dialog-buttonset").children('button:contains("Upload")').removeAttr("disabled").removeClass("ui-state-disabled");t.$document_form_fields.show()}},!1)},init_dialog_player:function(e){var t=this;if(typeof t.dialog_players[e]=="undefined"){var n=t.dialog_players[e]=document.getElementById("dialog_player_"+e),r=$("#dialog_player_"+e);r.on("loadedmetadata",function(){$("#dialog_phone_call_"+e).removeAttr("disabled");t.refresh_player_time(e,"dialog")});r.on("timeupdate",function(){$("#dialog_player_progress_"+e).attr("value",this.currentTime/this.duration);t.refresh_player_time(e,"dialog")});r.on("ended",function(){$("#dialog_player_play_"+e).html('<span class="play-icon"></span>')});typeof n.buffered=="object"&&n.buffered.length!==0&&$("#dialog_player_"+e).bind("progress",function(){var t=parseInt(n.buffered.end(0)/n.duration*100,10);$("#dialog_player_buffering_"+e).width(t<100?t+"%":0)})}return t.dialog_players[e]},init_player:function(e,t){"use strict";var n=this,r=null;if(t==="report")r=n.report_players;else{if(t!=="company"){alert("Please contact Dennis if you see this message, because it's not suppose to show up ;-(");return}r=n.company_players}if(typeof r[e]=="undefined"){var i=t+"_player_"+e,s=r[e]=document.getElementById(i),o=$("#"+i);o.on("loadedmetadata",function(){n.refresh_player_time(e,"",t)});o.on("timeupdate",function(){$("#"+t+"_player_progress_"+e).attr("value",this.currentTime/this.duration);n.refresh_player_time(e,"",t)});o.on("ended",function(){$("#"+t+"_player_play_"+e).html('<span class="play-icon"></span>')});typeof s.buffered=="object"&&s.buffered.length!==0&&o.bind("progress",function(){var n=parseInt(s.buffered.end(0)/s.duration*100,10);$("#"+t+"_player_buffering_"+e).width(n<100?n+"%":0)});s.load()}return r[e]},refresh_player_time:function(e,t,n){var r=this,i=null;if(t==="dialog")i=r.dialog_players[e];else if(n==="report")i=r.report_players[e];else{if(n!=="company"){alert("Please contact Dennis if you see this message, because it's not suppose to show up ;-(");return}i=r.company_players[e]}if(i===undefined)return;var s=r.format_time(Math.floor(i.currentTime).toString()),o=r.format_time(Math.floor(i.duration).toString());t==="dialog"?$("#dialog_player_status_"+e).html(s+"/"+o):$("#"+n+"_player_status_"+e).html(s+"/"+o)},format_time:function(e,t){var n=Math.floor(e/3600),r=Math.floor((e-n*3600)/60),i=Math.floor(e-n*3600-r*60);r<10&&(r="0"+r);i<10&&(i="0"+i);return r+":"+i},show_attach_phone_loader:function(e){$("#attach_phone_call_step"+e+" .inner").html('<div class="loader"></div>')},Phone_Call:function(e,t,n,r){this.filename=e;this.type=t;this.phone_number=n;this.time=r},refresh_phone_calls:function(e,t){var n=this;t=typeof t=="undefined"?!1:t;(e==="company"||e==="both")&&$("#company_phone_calls_container").html('<div class="phone-calls-loader"></div>');(e==="report"||e==="both")&&$("#report_phone_calls_container").html('<div class="phone-calls-loader"></div>');$sb.ajax.get("/get_phone_calls",{company:n.company_id,what:e},function(t){if(e==="company"||e==="both"){$("#company_phone_calls_container").html(t.data.html.company);var r=$("#company_phone_calls_container audio").length;n.company_players=[];for(var i=0;i<r;i++)n.init_player(i,"company")}if(e==="report"||e==="both"){$("#report_phone_calls_container").html(t.data.html.report);var s=$("#report_phone_calls_container audio").length;n.report_players=[];for(var o=0;o<s;o++)n.init_player(o,"report")}});if(t===!0){e==="company"?$("#tab_phone_call").tabs("select",0):e==="report"&&$("#tab_phone_call").tabs("select",1);$("#edit_company_tabs").tabs("select",2)}},format_bytes:function(e){var t=["Bytes","KB","MB","GB","TB"];if(e===0)return"N/A";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)),null);return n===0?e+" "+t[n]:(e/Math.pow(1024,n)).toFixed(1)+" "+t[n]},refresh_documents:function(e){var t=this;t.$documents_tbody.html('<tr><td colspan="4"><span id="documents_loader"></span></td></tr>');$sb.ajax.get("/get_documents",{company:t.company_id},function(n){t.$documents_tbody.html(n.data.html);e&&t.refresh_phone_calls("both",!1)})},pause_dialog_players:function(e){var t=this,n=t.dialog_players.length;for(var r=0;r<n;r++){if(e>-1&&typeof t.dialog_players[r]=="undefined"||r===e)continue;if(!t.dialog_players[r].paused){t.dialog_players[r].pause();$("#dialog_player_play_"+r).html('<span class="play-icon"></span>')}}},pause_company_players:function(e,t){var n=this,r=n.company_players.length;for(var i=0;i<r;i++){if(typeof n.company_players[i]=="undefined"||i===e&&t==="company")continue;if(!n.company_players[i].paused){n.company_players[i].pause();$("#company_player_play_"+i).html('<span class="play-icon"></span>')}}},pause_report_players:function(e,t){var n=this,r=n.report_players.length;for(var i=0;i<r;i++){if(typeof n.report_players[i]=="undefined"||i===e&&t==="report")continue;if(!n.report_players[i].paused){n.report_players[i].pause();$("#report_player_play_"+i).html('<span class="play-icon"></span>')}}},check:function(){var e=this,t=$sb.ajax;t.async=!1;t.post("/edit_company/"+e.company_id,e.form.serialize(),function(t){e.form.attr("onsubmit","");e.form.submit()})},setup_region_switch:function(){this.form=$("#edit-company");this.country_selector=this.form.find('select[name="country_code"]');this.rs=new RegionSwitcher;this.rs.region_field_class="region-field";this.rs.region_field_name="region";this.rs.disabled_region_field_name="disabled-region";this.rs.us_states_element="us-states";this.rs.ca_provinces_element="ca-provinces";this.rs.other_region_element="other_region";this.rs.region_label="region_label";this.rs.us_states_label_text="States:";this.rs.ca_provinces_label_text="Provinces:";this.rs.other_region_label_text="Region:";this.rs.start(this.form,this.country_selector)},_init:function(){this.setup_region_switch();this.binds()}};$sb.crm.edit_company=new edit_company;$(document).ready(function(){$sb.crm.edit_company.company_id=$sb.crm.id;$sb.crm.edit_company._init()});